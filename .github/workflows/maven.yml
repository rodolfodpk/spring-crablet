name: Java 25 CI with Maven

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    services:
      postgres:
        image: postgres:17.2
        env:
          POSTGRES_DB: crablet
          POSTGRES_USER: crablet
          POSTGRES_PASSWORD: crablet
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 25 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'  # Caches ~/.m2/repository

      - name: Build with Maven
        run: mvn -B clean install --file pom.xml

      - name: Generate JaCoCo Coverage Report
        run: mvn -B jacoco:report-aggregate --file pom.xml

      - name: Generate Coverage Badges
        if: always()
        run: |
          mkdir -p .github/badges
          
          if [ -f "target/site/jacoco-aggregate/jacoco.xml" ]; then
              python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import sys
          
          try:
              # Parse the JaCoCo aggregated report
              tree = ET.parse('target/site/jacoco-aggregate/jacoco.xml')
              root = tree.getroot()
              
              # Get overall line coverage
              line_counters = root.findall('.//counter[@type="LINE"]')
              if line_counters:
                  last_counter = line_counters[-1]
                  missed = int(last_counter.get('missed', 0))
                  covered = int(last_counter.get('covered', 0))
                  total = missed + covered
                  line_coverage = (covered / total) * 100 if total > 0 else 0
                  
                  # Generate JaCoCo badge
                  coverage_pct = int(line_coverage)
                  color = "brightgreen" if coverage_pct >= 80 else "green" if coverage_pct >= 60 else "yellowgreen" if coverage_pct >= 40 else "yellow" if coverage_pct >= 20 else "red"
                  
                  with open('.github/badges/jacoco.svg', 'w') as f:
                      f.write(f'<svg xmlns="http://www.w3.org/2000/svg" width="126" height="20">')
                      f.write(f'<linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>')
                      f.write(f'<clipPath id="a"><rect width="126" height="20" rx="3" fill="#fff"/></clipPath>')
                      f.write(f'<g clip-path="url(#a)"><path fill="#555" d="M0 0h63v20H0z"/><path fill="{color}" d="M63 0h63v20H63z"/><path fill="url(#b)" d="M0 0h126v20H0z"/></g>')
                      f.write(f'<g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">')
                      f.write(f'<text x="31.5" y="15" fill="#010101" fill-opacity=".3">coverage</text>')
                      f.write(f'<text x="31.5" y="14">coverage</text>')
                      f.write(f'<text x="60" y="15" fill="#010101" fill-opacity=".3">{coverage_pct}%</text>')
                      f.write(f'<text x="60" y="14">{coverage_pct}%</text>')
                      f.write(f'</g></svg>')
                  
                  print(f"üìä Line Coverage: {line_coverage:.2f}%")
                  print(f"   (covered: {covered}, missed: {missed})")
              
              # Get overall branch coverage
              branch_counters = root.findall('.//counter[@type="BRANCH"]')
              if branch_counters:
                  last_branch = branch_counters[-1]
                  branch_missed = int(last_branch.get('missed', 0))
                  branch_covered = int(last_branch.get('covered', 0))
                  branch_total = branch_missed + branch_covered
                  branch_coverage = (branch_covered / branch_total) * 100 if branch_total > 0 else 0
                  
                  branch_pct = int(branch_coverage)
                  color = "brightgreen" if branch_pct >= 80 else "green" if branch_pct >= 60 else "yellowgreen" if branch_pct >= 40 else "yellow" if branch_pct >= 20 else "red"
                  
                  with open('.github/badges/branches.svg', 'w') as f:
                      f.write(f'<svg xmlns="http://www.w3.org/2000/svg" width="130" height="20">')
                      f.write(f'<linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>')
                      f.write(f'<clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath>')
                      f.write(f'<g clip-path="url(#a)"><path fill="#555" d="M0 0h69v20H0z"/><path fill="{color}" d="M69 0h61v20H69z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g>')
                      f.write(f'<g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">')
                      f.write(f'<text x="34.5" y="15" fill="#010101" fill-opacity=".3">branches</text>')
                      f.write(f'<text x="34.5" y="14">branches</text>')
                      f.write(f'<text x="99.5" y="15" fill="#010101" fill-opacity=".3">{branch_pct}%</text>')
                      f.write(f'<text x="99.5" y="14">{branch_pct}%</text>')
                      f.write(f'</g></svg>')
                  
                  print(f"üåø Branch Coverage: {branch_coverage:.2f}%")
                  print(f"   (covered: {branch_covered}, missed: {branch_missed})")
                  
          except Exception as e:
              print(f"Error parsing coverage: {e}")
              sys.exit(1)
          EOF
          else
              echo "‚ö†Ô∏è Coverage report not found"
          fi
      
      - name: Commit Badges
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/badges/
          git diff --staged --quiet || git commit -m "chore: Update coverage badges [skip ci]"
          git push
